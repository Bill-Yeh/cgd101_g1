<!DOCTYPE html>
<html lang="en">

<head>
    @@include('layout/meta.html',{"title" : "寶物商城"})
</head>
<!--  -->

<body class="mall">

    @@include('layout/header.html')
    <div class="mall_wrap">

        <div class="mall_floor">
            <!-- 地板 -->
            <div class="mall_floor_pic">
                <img src="./images/mall_floor.png" alt="">
            </div>

            <!-- 商品區 -->
            <div class="mall_item_wrap">
                <div class="mall_item">
                    <div class="mall_product">
                        <!-- 商品切換 -->
                        <div class="tabs">
                            <input type="radio" name="tabs" id="tabone" checked="checked">
                            <!-- 課程 -->
                            <label for="tabone" class="tabone">課程</label>
                            <div class="tab">
                                <!-- 第一列 -->
                                <div class="item_1">
                                    <!-- 一之一 -->
                                    <div class="item_info">
                                        <div class="item_titlev lesson_title"></div>
                                        <div class="item_pic n4_word lesson" id="lesson_buy">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price ">
                                            <div class="item_price_text lesson_price" id="buy_price"></div>
                                        </div>
                                    </div>
                                    <!-- 一之二 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic n4_conversation lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 一之三 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic n3_word lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 一之四 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title lesson"></div>
                                        <div class="item_pic n3_conversation">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 第二列 -->
                                <div class="item_2">
                                    <!-- 二之一 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic n2_word lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 二之二 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic n2_conversation lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 二之三 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic n1_word lesson ">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 二之四 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic n1_conversation lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 第三列 -->
                                <div class="item_3">
                                    <!-- 三之一 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic all_word lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 三之二 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic all_conversation lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 三之三 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic add_conversation lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                    <!-- 三之四 -->
                                    <div class="item_info">
                                        <div class="item_title lesson_title"></div>
                                        <div class="item_pic add_word lesson">
                                            <img src="" class="lesson_img">
                                            <div class="lesson_having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_text lesson_price"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>



                            <input type="radio" name="tabs" id="tabtwo">
                            <!-- 裝備 -->
                            <label for="tabtwo" class="tabtwo">裝備</label>
                            <div class="tab">
                                <div class="item_1">
                                    <!-- 一之一 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_1 hat">

                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>

                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price" id="show_box" name="item_price">
                                            </div>
                                        </div>
                                    </div>
                                    <!-- 一之二 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_2 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 一之三 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_3 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 一之四 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_4 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 第二列 -->
                                <div class="item_2">
                                    <!-- 二之一 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_5 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 二之二 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_6 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 二之三 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_7 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 二之四 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_hat_8 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 第三列 -->
                                <div class="item_3">
                                    <!-- 三之一 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_dress_1 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 三之二 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_dress_2 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 三之三 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_dress_3 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                    <!-- 三之四 -->
                                    <div class="item_info_tool">
                                        <div class="item_title tool_title"></div>
                                        <div class="item_pic mall_dress_4 hat">
                                            <img src="" class="tool_img">
                                            <div class="having"></div>
                                        </div>
                                        <div class="item_price">
                                            <div class="item_price_pic tool_coin">
                                                <img src="./images/nav_coin.png" alt="">
                                            </div>
                                            <div class="item_price_text tool_price"></div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>



                    <div class="mall_npc">
                        <div class="npc_pic"><img src="./images/mall_npc1.png" alt="">
                        </div>

                        <div class="npc_talk">
                            <img src="./images/talk.png">

                            <p class="talk_content">
                                &nbsp;&nbsp;いらっしゃいませ,何が買いたいですか？<br>
                                &emsp;&emsp;&emsp;（歡迎光臨，想買些什麼呢？）
                            </p>

                        </div>
                    </div>
                    <div class="mall_floor_item_pic">
                        <img src="./images/mall_floor_item.png" alt="">
                    </div>
                </div>
                <div class="mall_rwd_floor">
                    <img src="./images/mall_rwd_floor.png" alt="">
                </div>
            </div>

            <!-- 確認是否購買課程--燈箱 -->
            <div class="pay_box" id="pay_box">
                <div class="text_box" id="text_box">
                    <div class="text" id="lesson_chioce">是否確認購買?</div>
                    <div class="tool_text" id="lesson_having" style="display: none;">無法重複購買</div>
                    <div class="choice">
                        <div class="yes_btn" id="yes_btn">確認</div>
                        <div class="no_btn" id="no_btn">取消</div>
                    </div>
                </div>
            </div>
            <!-- 確認是否購買裝備--燈箱 -->
            <div class="tool_box" id="tool_box">
                <div class="tool_text_box" id="tool_text_box">
                    <div class="tool_text" id="tool_choice">是否確認購買?</div>
                    <div class="tool_text" id="tool_having" style="display: none;">無法重複購買</div>
                    <div class="tool_text" id="no_coin" style="display: none;">代幣不足</div>
                    <div class="choice">
                        <div class="tool_yes_btn" id="tool_y_btn">確認</div>
                        <div class="tool_no_btn" id="tool_n_btn">取消</div>
                    </div>
                </div>
            </div>
            @@include('layout/login_register.html')



            <script>
                //==========撈課程資料寫入HTML==========
                let lessonxhr = new XMLHttpRequest();
                let lesson_title = document.querySelectorAll(".lesson_title");
                let lesson_price = document.querySelectorAll(".lesson_price");
                let lesson_img = document.querySelectorAll(".lesson_img");

                lessonxhr.open("get", "./mall_lesson_info.php", true);

                lessonxhr.send(null);

                lessonxhr.onload = function () {
                    let lesson = JSON.parse(lessonxhr.responseText);

                    //i=要放入課程的欄位
                    for (i = 0; i < lesson.length; i++) {
                        //j=要從資料庫第幾個課程開始抓取
                        for (j = 10; j < lesson.length; j++) {
                            //從lesson_id:12開始抓取
                            if (lesson[j].lesson_id == i + 16) {
                                lesson_title[i].innerText = lesson[j].lesson_name;
                                lesson_price[i].innerText = "$" + lesson[j].lesson_price;
                                lesson_img[i].src = lesson[j].lesson_img;

                                //console.log(i + 12);
                            }
                        }
                    }
                };
                //==========撈課程資料寫入HTML_end==========

                //==========會員已擁有的課程,顯示在頁面上==========

                let having_lessonxhr = new XMLHttpRequest();
                let lesson = document.querySelectorAll(".lesson");
                let lesson_having = document.querySelectorAll(".lesson_having");
                let lesson_price__text = document.querySelectorAll(".lesson_price");


                having_lessonxhr.open("get", "./mall_having_lesson.php", true);

                having_lessonxhr.send(null);

                having_lessonxhr.onload = function () {
                    let having_lesson = JSON.parse(having_lessonxhr.responseText);

                    //當抓不到東西時,就會停止動作
                    if (!having_lesson) return;

                    //having_lesson儲存成新陣列,只顯示value
                    having_lesson = having_lesson.map((v) => v.lesson_id);
                    console.log(having_lesson);

                    for (i = 0; i < having_lesson.length; i++) {
                        let lesson_idx = having_lesson[i] - 1;
                        lesson_having[lesson_idx].style.display = "block";
                        lesson_price__text[lesson_idx].innerText = "已擁有";
                    }

                };
                //==========會員已擁有的課程,顯示在頁面上_end==========



                //==========撈資料庫裝備資料寫入HTML==========
                let item_titlexhr = new XMLHttpRequest();
                let title = document.querySelectorAll(".tool_title");
                let tool_price = document.querySelectorAll(".tool_price");
                let tool_img = document.querySelectorAll(".tool_img");
                //console.log(title)
                item_titlexhr.open("get", "./mall_item_info.php", true);

                item_titlexhr.send(null);

                item_titlexhr.onload = function () {
                    let item = JSON.parse(item_titlexhr.responseText);

                    for (i = 0; i < item.length; i++) {
                        // console.log(item[i].item_name);
                        if (item[i].item_id == i + 1) {
                            if (!title[i]) return;
                            // console.log(i);
                            title[i].innerText = item[i].item_name;
                            tool_price[i].innerText = item[i].item_price;
                            tool_img[i].src = item[i].item_img;
                        }
                    }
                };
                //==========撈資料庫裝備資料寫入HTML_end==========



                //==========會員已擁有的裝備,顯示在頁面上==========
                let having_itemxhr = new XMLHttpRequest();
                let hat = document.querySelectorAll(".hat");
                let having = document.querySelectorAll(".having");
                let tool_coin = document.querySelectorAll(".tool_coin");
                let tool_coin_text = document.querySelectorAll(".tool_price");

                having_itemxhr.open("get", "./mall_having_item.php", true);

                having_itemxhr.send(null);

                having_itemxhr.onload = function () {
                    let having_item = JSON.parse(having_itemxhr.responseText);

                    //當抓不到東西時,就會停止動作
                    if (!having_item) return;

                    //having_item儲存成新陣列,只顯示value
                    having_item = having_item.map((v) => v.item_id);
                    //console.log(having_item);

                    for (i = 0; i < having_item.length; i++) {
                        let item_idx = having_item[i] - 1;
                        having[item_idx].style.display = "block";
                        tool_coin[item_idx].style.display = "none";
                        tool_coin_text[item_idx].innerText = "已擁有";
                    }


                };

                //==========會員已擁有的裝備,顯示在頁面上_end==========

            </script>



            <script>

                //==========燈箱區==========

                //裝備
                let tool = document.querySelectorAll(".hat");
                let show_tool = document.getElementById("tool_box");
                let tool_no = document.getElementById("tool_n_btn");
                let tool_yes = document.getElementById("tool_y_btn");


                //課程
                let lesson_no = document.getElementById("no_btn");
                let lesson_yes = document.getElementById("yes_btn");
                let lesson_pay = document.getElementById("pay_box");
                let lesson_pay_box = document.querySelectorAll(".item_info");

                //登入狀態
                let name = document.getElementById("memName");
                let loginRegister = document.getElementById("login_register");

                let mem_coin = document.getElementById("mem_coin");


                function tool_login() {
                    //如果名字是空字串,跳登入燈箱
                    if (name.innerText == "") {
                        loginRegister.style.display = "flex";
                    }
                    //else if,跳確認購買燈箱
                    else if (name.innerText != "") {
                        tool_pay();
                    }
                }

                function lesson_login() {
                    //如果名字是空字串,跳登入燈箱
                    if (name.innerText == "") {
                        loginRegister.style.display = "flex";
                    }
                    //else if,跳確認購買燈箱 
                    else if (name.innerText != "") {
                        show_box();
                    }
                }

                function tool_pay() {
                    show_tool.style.display = "block";
                }

                function tool_n_btn() {
                    show_tool.style.display = "none";
                }


                function show_box() {
                    lesson_pay.style.display = "block";
                }

                function no_button() {
                    lesson_pay.style.display = "none";
                }

                function yes_button() {
                    window.location.href = "./payment.html";
                    let lesson_buy = document.getElementById("lesson_buy")
                    if (Number(coin.innerText) >= 0) {
                        let buy_lesson_id = 16;
                        let xhr = new XMLHttpRequest();
                        let url = `./mall_buy_lesson.php?lesson_id=${buy_lesson_id}`
                        console.log(url);
                        xhr.open("get", url, true);
                        xhr.send(null);
                        xhr.onload = function () {
                            console.log("123")
                            // let buy_item = JSON.parse(xhr.responseText);
                            // mem_coin.innerText = now_coin;
                            //location.reload()
                        }
                    }
                }



                //==========讓裝備無法重複購買==========
                for (let i = 0; i < tool.length; i++) {
                    //console.log(i);
                    tool[i].addEventListener("click", function () {
                        let having_text = document.getElementById("tool_having");
                        let tool_choice = document.getElementById("tool_choice");
                        let no_coin = document.getElementById("no_coin");
                        let tool_having = document.getElementById("tool_having");
                        tool_yes.onclick = tool_y_btn;
                        //console.log(i);
                        if (tool_coin_text[i].innerText == "已擁有") {
                            having_text.style.display = "block"
                            tool_choice.style.display = "none";
                            tool_no.style.display = "none";
                        }
                        else if (tool_coin_text[i].innerText != "已擁有") {
                            having_text.style.display = "none"
                            tool_choice.style.display = "block";
                        } if (Number(coin.innerText) - Number(tool_coin_text[i].innerText) <= 0) {
                            having_text.style.display = "none"
                            tool_choice.style.display = "none";
                            tool_no.style.display = "none";
                            no_coin.style.display = "block"
                        }

                        function tool_y_btn() {
                            show_tool.style.display = "none";

                            //if 會員的代幣 - 裝備的代幣 >=0
                            if (Number(coin.innerText) - Number(tool_coin_text[i].innerText) >= 0) {

                                //剩餘代幣 = 相減之後的數量
                                now_coin = Number(coin.innerText) - Number(tool_coin_text[i].innerText)

                                tool_coin[i].style.display = "none";

                                //利用ajax呼叫PHP來處理代幣資料
                                let xhr = new XMLHttpRequest();
                                let url = `./mall_coin.php?coin=${now_coin}`
                                xhr.open("get", url, true);
                                xhr.send(null);
                                xhr.onload = function () {
                                    let having_coin = JSON.parse(xhr.responseText);
                                    mem_coin.innerText = now_coin;
                                    //console.log(having_coin)
                                    //location.reload()
                                };
                            }

                            if (Number(coin.innerText) - Number(tool_coin_text[i].innerText) >= 0) {
                                let buy_item_id = i + 1;
                                console.log(buy_item_id);
                                let xhr = new XMLHttpRequest();
                                let url = `./mall_buy_item.php?item_id=${buy_item_id}`
                                console.log(url);
                                xhr.open("get", url, true);
                                xhr.send(null);
                                xhr.onload = function () {
                                    console.log(xhr.responseText)
                                    // let buy_item = JSON.parse(xhr.responseText);
                                    // mem_coin.innerText = now_coin;

                                    location.reload()
                                }
                            }
                        }


                    }

                    );


                }

                //==========讓裝備無法重複購買_end==========

                //==========讓課程無法重複購買==========
                for (let i = 0; i < lesson_pay_box.length; i++) {
                    //console.log(i);
                    lesson_pay_box[i].addEventListener("click", function () {
                        let lesson_having_text = document.getElementById("lesson_having");
                        let lesson_choice = document.getElementById("lesson_chioce");
                        //console.log(i);
                        if (lesson_price__text[i].innerText == "已擁有") {
                            lesson_having_text.style.display = "block"
                            lesson_choice.style.display = "none";
                            lesson_yes.style.display = "none";
                            lesson_no.innerText = "確認"
                        }
                        else if (lesson_price__text[i].innerText != "已擁有") {
                            lesson_having_text.style.display = "none"
                            lesson_choice.style.display = "block";
                            lesson_yes.style.display = "block";
                        }
                    });
                }
                //==========讓課程無法重複購買_end==========




                //let xhr = new XMLHttpRequest();
                // xhr.open("get", "", true);


                function init() {
                    lesson_pay_box.onclick = show_box;
                    lesson_no.onclick = no_button;
                    lesson_yes.onclick = yes_button;
                    tool_no.onclick = tool_n_btn;


                    for (i = 0; i < lesson_pay_box.length; i++) {
                        lesson_pay_box[i].onclick = lesson_login;
                    }

                    for (i = 0; i < tool.length; i++) {
                        tool[i].onclick = tool_login;
                    }


                }

                window.addEventListener("load", init, false)



            </script>

</body>