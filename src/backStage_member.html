<!DOCTYPE html>
<html lang="en">
<head>
    @@include('layout/meta.html', {
        "title" : "後台會員管理"
    })
</head>
<body class="backMem backStyle" style="background-color: #fff;">
    <!-- header -->
    @@include('layout/backStage_header.html')
    <!-- header end -->

    <!-- 後台左右邊內容 -->
    <div id="backStageID" class="backStage_main_container">
        <div class="backStage_main_content">
            <!-- 後台左方選單 -->
            @@include('layout/backStage_nav.html')

            <div class="backStage_right_part">
                <div class="backStage_right_content">
                    <div class="backStage_right_title_part">
                        <div class="backStage_right_title">
                            <h1>會員管理</h1>
                        </div>
                        <!-- <div class="backStage_filter backStage_addAccount">
                            <button class="lightBox_btn" @click="show"><i class="bi bi-funnel-fill"></i>條件篩選</button>
                        </div> -->
                        <div class="backStage_input_filter">
                            <div class="input_filter">
                                <input type="text" placeholder="以關鍵字查詢" v-model="search" @change="search_txt"/>
                                <i class="bi bi-search"></i>
                            </div>
                            <div class="backStage_search">
                                <button class="backStage_search_btn" @click="search_txt">
                                    查詢
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="backStage_right_table_part">
                        <table class="account_table_title table_title">
                            <tr class="table_header_row">
                                <th>會員編號</th>
                                <th>會員名稱</th>
                                <th>帳號</th>
                                <th>密碼</th>
                                <th>會員狀態</th>
                                <th>會員稱號</th>
                                <th>會員等級</th>
                            </tr>
                            <tr class="table_data_row odd" v-for="memberRow in memberRows">
                                <td>{{memberRow.member_id}}</td>
                                <td>{{memberRow.member_name}}</td>
                                <td>{{memberRow.account}}</td>
                                <td>{{memberRow.password}}</td>
                                <td>{{memberRow.member_status}}</td>
                                <td>{{memberRow.title}}</td>
                                <td>{{memberRow.level}}</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <!-- 表格底下的頁數 -->
                <footer class="backStage_footer backStage_footer_qData">
                    <ul class="footer_list">
                        <li class="arrow double-left" :class="arrow_disable_l(current_page)">
                            <i class="bi bi-chevron-double-left" :class="arrow_i_disable_l(current_page)" @click="toPage(1)"></i>
                        </li>
                        <li class="arrow arrow_left" :class="arrow_disable_l(current_page)">
                            <i class="bi bi-chevron-left" :class="arrow_i_disable_l(current_page)" @click="toPage(current_page-1)"></i>
                        </li>
                        <li class="page_num" v-for="page in all_pages" @click="toPage(page)" :class="page_now(page)">
                            {{page}}
                        </li>
                        <li class="arrow arrow_right" :class="arrow_disable_r(current_page)">
                            <i class="bi bi-chevron-right" :class="arrow_i_disable_r(current_page)" @click="toPage(current_page+1)"></i>
                        </li>
                        <li class="arrow double-right" :class="arrow_disable_r(current_page)">
                            <i class="bi bi-chevron-double-right" :class="arrow_i_disable_r(current_page)" @click="toPage(all_pages.length)"></i>
                        </li>
                    </ul>
                </footer>
            </div>
            
            <!-- 新增帳號燈箱 -->
            <div class="backStage_lightBox">
                <div class="backStage_lightBox_container">
                    <div class="backStage_lightBox_content">
                        <div class="backStage_lightBox_title">
                            <h3>編輯會員</h3>
                        </div>
                        <div class="backStage_lightBox_close" @click="hide">
                            <i class="bi bi-x-lg"></i>
                        </div>
                        <div class="backStage_lightBox_main_content">
                            <form action="">
                                <div class="member_sm_block">
                                    <label for="member_sm">會員編號</label>
                                    <input type="text" id="member_sm">
                                </div>
                                <div class="account_block">
                                    <label for="account">帳號</label>
                                    <input type="text" id="account">
                                </div>
                                <div class="account_title_block member_title_block">
                                    <label for="member_title">會員名稱</label>
                                    <input type="text" id="member_title">
                                </div>
                                <div class="phone_block">
                                    <label for="cellphone">手機</label>
                                    <input type="text" id="cellphone">
                                </div>
                                <div class="account_state_block member_state_block">
                                    <label for="member_state">會員狀態</label>
                                    <select name="" id="member_state">
                                        <option value="active">啟用</option>
                                        <option value="stop">停用</option>
                                    </select>
                                </div>
                                <div class="member_nickname_block">
                                    <label for="member_nickname">會員稱號</label>
                                    <select name="" id="member_nickname">
                                        <option value="">初心者</option>
                                        <option value="">冒險者</option>
                                        <option value="">探險者</option>
                                        <option value="">大探險者</option>
                                        <option value="">超探險者</option>
                                        <option value="">究極探險者</option>
                                        <option value="">無敵探險者</option>
                                        <option value="">神探險者</option>
                                        <option value="">極醒探險者</option>
                                        <option value="">超銀河探險者</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="backStage_lightBox_saveBtn">
                            <button type="submit" class="data_save">儲存</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- @@include('layout/backStage_footer.html') -->
        </div>
    </div>

    <script>
        let backStage_member = new Vue({
            el:'#backStageID',
            data:{
                // 頁面渲染用
                memberRows:[],
                // 分頁用
                data_perPage:15,
                all_pages:[],
                current_page:1,
                // 搜尋用
                search_arr : [], //查詢的資料
                temp_arr : [], //暫存所有資料
                search:'',
            },
            methods: {
                show(){
                    document.querySelector('.backStage_lightBox').style.display = 'flex';
                },
                hide(){
                    document.querySelector('.backStage_lightBox').style.display = 'none';
                },
                page_now(page){
                    if(page == this.current_page){
                        return 'currentPage';
                    }
                },
                arrow_disable_l(){
                    if(this.current_page == 1){
                        return 'arrow_disable';
                    }
                },
                arrow_i_disable_l(){
                    if(this.current_page == 1){
                        return 'arrow_i_disable';
                    }
                },arrow_disable_r(){
                    if(this.current_page == this.all_pages.length){
                        return 'arrow_disable';
                    }
                },
                arrow_i_disable_r(){
                    if(this.current_page == this.all_pages.length){
                        return 'arrow_i_disable';
                    }
                },
                toPage(page){
                    this.current_page = page;
                    //改變表格內容
                    if(this.search == ''){
                            if(page != parseInt((this.temp_arr.length / this.data_perPage)+1)){
                            this.memberRows = [];
                            for(let i=((page-1)*this.data_perPage);i<=(page*this.data_perPage-1);i++){
                                this.memberRows.push(this.temp_arr[i]);
                            }
                        }else{
                            this.memberRows = [];
                            for(let i=((page-1)*this.data_perPage);i<=(this.temp_arr.length-1);i++){
                                this.memberRows.push(this.temp_arr[i]);
                            }
                        };
                    }else{
                        if(page != parseInt((this.search_arr.length / this.data_perPage)+1)){
                            this.memberRows = [];
                            for(let i=((page-1)*this.data_perPage);i<=(page*this.data_perPage-1);i++){
                                this.memberRows.push(this.search_arr[i]);
                            }
                        }else{
                            this.memberRows = [];
                            for(let i=((page-1)*this.data_perPage);i<=(this.search_arr.length-1);i++){
                                this.memberRows.push(this.search_arr[i]);
                            }
                        };
                    }
                },
                search_txt(){
                    console.log('開始查詢');
                    let search = this.search;
                    this.search_arr = [];
                    let reg=new RegExp(search);
                    if(search == ''){
                        this.search_arr = this.temp_arr;
                        console.log('結果空值');
                    }else{
                        this.search_arr = [];
                        for(let i = 0; i<this.temp_arr.length;i++){
                            if(this.temp_arr[i].member_id == search){
                                this.search_arr.push(this.temp_arr[i]);
                            }
                            else if(this.temp_arr[i].member_name == search){
                                this.search_arr.push(this.temp_arr[i]);
                            }else if(this.temp_arr[i].account == search){
                                this.search_arr.push(this.temp_arr[i]);
                            }else if(this.temp_arr[i].title == search){
                                this.search_arr.push(this.temp_arr[i]);
                            }else if(reg.test(this.temp_arr[i].backstage_account) == true){
                                this.search_arr.push(this.temp_arr[i]);
                            }else if(reg.test(this.temp_arr[i].member_name) == true){
                                this.search_arr.push(this.temp_arr[i]);
                            }else if(reg.test(this.temp_arr[i].title) == true){
                                this.search_arr.push(this.temp_arr[i]);
                            };
                        };
                        
                    };
                    this.memberRows = this.search_arr;

                    //===== 表格分頁 =====//
                    this.all_pages = [];
                    this.current_page = 1;
                    //產出頁數
                    if(this.memberRows.length < this.data_perPage){
                        this.all_pages.push(1);
                    }else if(this.memberRows.length % this.data_perPage == 0){
                        for(let i=1;i<=(this.memberRows.length / this.data_perPage);i++){
                            this.all_pages.push(i);
                        };
                    }else{
                        for(let i=1;i<=((this.memberRows.length / this.data_perPage)+1);i++){
                            this.all_pages.push(i);
                        };
                    };

                    // //產出初始表格
                    if(this.search_arr == []){
                        if(this.temp_arr.length < this.data_perPage){
                            for(let i=0;i<this.temp_arr.length;i++){
                                this.memberRows.push(this.temp_arr[i]);
                            };
                        }else{
                            for(let i=0;i<=this.data_perPage-1;i++){
                                this.memberRows.push(this.temp_arr[i]);
                            };
                        };
                    }else{
                        if(this.all_pages.length>1){
                            this.memberRows = [];
                            for(let i=0;i<this.data_perPage;i++){
                                this.memberRows.push(this.search_arr[i]);
                            };
                        };
                    };
                },
            },
            created(){
                let xhr = new XMLHttpRequest();
                xhr.onload = () =>{
                    // this.memberRows = JSON.parse(xhr.responseText);
                    this.temp_arr = JSON.parse(xhr.responseText);

                    //===== 表格分頁 =====//
                    //產出頁數
                    if(this.temp_arr.length < this.data_perPage){
                        this.all_pages.push(1);
                    }else if(this.temp_arr.length % this.data_perPage == 0){
                        for(let i=1;i<=(this.temp_arr.length / this.data_perPage);i++){
                            this.all_pages.push(i);
                        };
                    }else{
                        for(let i=1;i<=((this.temp_arr.length / this.data_perPage)+1);i++){
                            this.all_pages.push(i);
                        };
                    };
                    //寫入初始表格
                    if(this.temp_arr.length < this.data_perPage){
                        for(let i=0;i<this.temp_arr.length;i++){
                            this.memberRows.push(this.temp_arr[i]);
                        };
                    }else{
                        for(let i=0;i<=this.data_perPage-1;i++){
                            this.memberRows.push(this.temp_arr[i]);
                        };
                    };
                }
                xhr.open("get","back_member.php",true);
                xhr.send(null);
            }
        })
    </script>

</body>
</html>